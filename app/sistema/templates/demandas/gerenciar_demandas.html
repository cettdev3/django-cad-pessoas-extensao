{% extends "base.html" %}

{% block content %}
<div style="width: 100%;" class="">
    <div class="w-100 shadow
    d-flex justify-content-between align-items-center 
    px-3 py-3 my-3
    bg-white">
        <div class="d-flex justify-content-start align-items-center ">
            <div class="d-flex flex-column justify-content-start align-items-start mx-2">
                <label for="filterDemandaFavorecido" class="filter-label">Favorecido</label>
                <input id="filterDemandaFavorecido" class="form-control-sm border-secondary" name="favorecido"
                    type="text">
            </div>
            <div class="d-flex flex-column justify-content-start align-items-start mx-2">
                <label for="filterDemandaEscola" class="filter-label">Escola</label>
                <input id="filterDemandaEscola" class="form-control-sm border-secondary"
                name="escola" type="text">
            </div>
            <input type="text" hidden id="filterDemandaStatus" name="order_by">
            <div class="d-flex flex-column justify-content-start align-items-start mx-2">
                <label for="filterDemandaStatus" class="filter-label">Status</label>
                <select name="status" id="filterDemandaStatus" class="form-control-sm border-secondary">
                    <option value="">Selecione uma opção</option>
                    <option value="CRIACAO_PENDENTE">CRIACãO PENDENTE</option>
                    <option value="CRIADO">CRIADO</option>
                    <option value="ATRASADO_PARA_CRIACAO">ATRASADO PARA CRIACAO</option>
                    <option value="PENDING_PRESTACAO_CONTAS">PRESTACAO DE CONTAS PENDENTE</option>
                    <option value="PRESTACAO_CONTAS_CREATED">PRESTADO CONTAS</option>
                    <option value="CANCELADO">CANCELADO</option>
                </select>
            </div>
            <div class="d-flex flex-column justify-content-start align-items-start mx-2">
                <label for="filterDemandaIDProtocolo" class="filter-label">ID da demanda</label>
                <input id="filterDemandaIDProtocolo" class="form-control-sm border-secondary"
                name="id_protocolo" type="text">
            </div>
            <input type="text" name="order_by" id="filterDemandaOrderBy" hidden>
        </div>
        <div class="d-flex">
            <button id="relatorioDpEvento" onclick="emitirRelatorio()"
                class="btn-cadastrar rounded d-flex justify-content-between align-items-center mr-2">
                <span>Emitir Relatório</span>
            </button>
            <button id="adicionarDemanda" 
            onclick="carregarDemandasModal()"
            class="btn-cadastrar rounded d-flex justify-content-between align-items-center">
                <span>Cadastrar Demanda</span>
            </button>
        </div>
    </div>

    <div class="w-100" id="demandasTable">
    </div>

</div>
<script>
    function getDemandaFilters() {
        let filtros = {}
        $("*[id^='filterDemanda']").each(function () {

            if ($(this).val()) {
                filtros[$(this).attr("name")] = $(this).val()
            }
        })
        return filtros
    }

    function carregarDemandasModal() {
        $.ajax({
            url: "/ticketModal",
            data: { 
                membro_execucao_id: null, 
                model: "pessoa",
                layout: 6 
            },
            success: function (data) {
                $("#" + "modalTicketContainer").html(data);
                $('#' + "cadastrarTicketModal").modal('toggle');
            }
        });
    }
    
    function carregarDemandas(filters= null, state = null) {
        $.ajax({
            url: "/demandas_tabela",
            type: "GET",
            data: filters,
            success: function (data) {
                $("#demandasTable").html(data);
                setTabelaState(state, 'column-demanda', "-tipo")
            }
        });
    }

    function startFilterControl() {
        $("*[id^='filterDemanda']").each(function () {
            let input = $(this)
            if ($(this).attr('type') == 'text') {
                $(this)
                .keyup(debounce(function() {
                    carregarDemandas(getDemandaFilters())
                }, 500))
            } else {
                $(this)
                .change(debounce(function() {
                    carregarDemandas(getDemandaFilters())
                }, 500))
            }
        })
    }

    function emitirRelatorio() {
        const xhr = new XMLHttpRequest();
        let uri = '/relatorio_sintetico'
        xhr.open('GET', uri, true);
        xhr.addEventListener('progress', event => {
            if (event.lengthComputable) {
                const percentComplete = (event.loaded / event.total) * 100;
                console.log('Download progress:', percentComplete + '%');
            }
        });

        xhr.responseType = 'blob';
        
        xhr.onload = event => {
            if (xhr.status === 200) {
                const blob = xhr.response;
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'relatorio_sintetico.xlsx';
                a.target = '_blank';
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
                $("#modalRelatorioEventos").modal("toggle");
            } else {
                console.error('Download failed:', xhr.statusText);
            }
        };

        xhr.send();
    };

    $(document).ready(function () {
        carregarDemandas()
        startFilterControl()
    })
</script>
{% endblock content %}