<style>

</style>
<div class="modal fade" id="modalRelatorioEventos" tabindex="-1" role="dialog" aria-labelledby="modalRelatorioEventosLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalRelatorioEventosTitle">
                    Filtros
                </h5>
                <button type="button" id="dismisModalCalendario" class="close" data-dismiss="modal" aria-label="Close">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="filtrosRelatorioModal">
                    <div class="form-group row">
                        <div class="col-sm-4" id="filtrorelatorioEventosDepartamentoSelect">
                        </div>
                        <div class="col-sm-4">
                            <label><b>Data de Inicio:</b></label>
                            <input type="date" class="form-control" id="data_inicio" name="data_inicio">
                        </div>
                        <div class="col-sm-4">
                            <label><b>Data de Fim:</b></label>
                            <input type="date" class="form-control" id="data_fim" name="data_fim">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button onclick="gerarRelatorio()" 
                id="confimarModalCalendario" 
                type="button" 
                class="btn btn-primary">
                    <span>Gerar Relatorio</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function loadEventoRelatorioDepartamentoSelect() {
        $.ajax({
            url: "/departamentosSelect",
            type: "GET",
            success: function (data) {
                $("#filtrorelatorioEventosDepartamentoSelect").html(data);
            },
            error: function (data) {
                console.log(data);
            }
        });
    }

    function getFiltroRelatorioEvento() {
        var data_inicio = $("#data_inicio").val();
        var data_fim = $("#data_fim").val();
        var departamento_id = $("#filtrorelatorioEventosDepartamentoSelect select").val();
        var filtros = {
            data_inicio: data_inicio,
            data_fim: data_fim,
            departamento_id: departamento_id
        }
        return filtros;
    }

    function gerarRelatorio() {
        filtros = getFiltroRelatorioEvento();
        console.log(filtros)
        const xhr = new XMLHttpRequest();
        let uri = '/relatorioDpEvento'
        let params = Object.keys(filtros).map(function (key) {
            return encodeURIComponent(key) + '=' + encodeURIComponent(filtros[key]);
        }).join('&');
        console.log(uri, "?"+params)
        xhr.open('GET', uri+"?"+params, true);
        xhr.addEventListener('progress', event => {
        if (event.lengthComputable) {
            const percentComplete = (event.loaded / event.total) * 100;
            console.log('Download progress:', percentComplete + '%');
        }
        });

        xhr.responseType = 'blob';
        
        xhr.onload = event => {
            if (xhr.status === 200) {
                const blob = xhr.response;
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'relatorio_eventos.docx';
                a.target = '_blank';
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
                $("#modalRelatorioEventos").modal("toggle");
            } else {
                console.error('Download failed:', xhr.statusText);
            }
        };

        xhr.send();
        console.log("filtros")
    }

    $(document).ready(function () {
        loadEventoRelatorioDepartamentoSelect();
    })
</script>