<style>
    :root {
        --acaoModalHeaderHeight: 120px;
        --acaoModalFooterHeight: 50px;
    }

    .custom-modal-fade {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
    }

    .custom-modal {
        position: fixed;
        border-radius: 5px;
        top: 20%;
        left: 50%;
        max-height: 100vh;
        max-width: 100vw;
        overflow: hidden;
        transform: translate(-50%, -20%);
        background-color: #fff;
        z-index: 1000;
    }

    .custom-modal-header {
        position: relative;
        width: 100%;
        max-height: var(--acaoModalHeaderHeight);
        background-color: #fff;
        z-index: 1001;
    }

    .custom-modal-body {
        position: relative;
        background-color: #fff;
        z-index: 1001;
    }

    .custom-modal-footer {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        position: relative;
        width: 100%;
        height: var(--acaoModalFooterHeight);
        background-color: #fff;
        z-index: 1001;
    }

    .custom-close-modal {
        height: 40px;
        cursor: pointer;
        background-color: #fff;
        border:none;
        z-index: 1002;
    }

    .custom-modal-large-content {
        max-width: 95vw !important;
        max-height: calc(100vh - var(--acaoModalFooterHeight) - var(--acaoModalHeaderHeight));
    }

    .custom-modal-medium-content {
        max-width: 75vw !important;
        max-height: calc(75vh - var(--acaoModalFooterHeight) - var(--acaoModalHeaderHeight));
    }

    .custom-modal-small-content {
        max-width: 50vw !important;
        max-height: calc(50vh - var(--acaoModalFooterHeight) - var(--acaoModalHeaderHeight));
    }

    .bg-red {
        background-color: red;
    }

    .acao-modal-header-title {
        font-size: 1.5rem;
    }

    .custom-modal-body-container {
        max-height: calc(100vh - var(--acaoModalFooterHeight) - var(--acaoModalHeaderHeight)); 
        overflow-y: auto; 
        overflow-x: hidden;
    }

    .w-100-perc {
        width: 100%!important; 
    }
    
    .w-75-perc {
        width: 75%!important; 
    }

    .w-100-vw {
        width: 100vw!important; 
    }
    
    .w-75-vw {
        width: 75vw!important; 
    }

    .acao-modal-itinerario-container {
        width: 100%; 
        height: calc(95vh - var(--acaoModalFooterHeight) - var(--acaoModalHeaderHeight)); 
        background-color: #fff;
    }
</style>
<div id="document"></div>
<div class="custom-modal-fade"></div>
<div class="custom-modal">
    <div class="custom-modal-header pl-2">
        <div class="d-flex flex-column">
            <div class="acao-modal-header-title d-flex justify-content-between">
                {% if not acao %}
                <span class="py-2">Cadastrar ação</span>
                {% else %}
                <span class="py-2">Editar ação</span>
                {% endif %}
                <button type="button" style="width: 50px; color: gray;" 
                class="custom-close-modal d-flex justify-content-center align-items-center p-2">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <ul class="nav nav-tabs row" style="height: 100%;">
                <li id="acaoTabs1" class="col mx-2 active-acao-form-tab ">
                    <a id="acoesTabLink1" data-toggle="tab" style="display: none;" role="tab" href="#home">1</a>
                    <span>1 Dados Gerais</span>
                </li>
                {% if not acao %}
                <li id="acaoTabs2" class="col mx-2">
                    <a id="acoesTabLink2" data-toggle="tab" style="display: none;" role="tab" href="#pessoas">2</a>
                    <span>2 Equipe de Execução</span>
                </li>
                <li id="acaoTabs3" class="col mx-2">
                    <a id="acoesTabLink3" data-toggle="tab" style="display: none;" role="tab" href="#itinerarios">3</a>
                    <span>3 Itinerários</span>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
    <div class="custom-modal-body custom-modal-large-content">
        <form id="cadastrarAcaoForm" class="custom-modal-body-container w-75-vw px-2">
            <div id="acao-tabs" class="tab-content">
                <div id="home" class="tab-pane active">
                    {% include "acoes/acao_form.html" with acao=acao %}
                </div>
                {% if not acao %}
                <div id="pessoas" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="h3">Adicionar Equipe de Execução</span>
                        <div class="d-flex justify-content-end">
                            <div class="form-group d-flex justify-content-start align-items-start">
                                <input name="use_acao_endereco"  
                                id="use_acao_endereco" 
                                style="width: 10%; cursor: pointer" 
                                type="checkbox">
                                <label for="use_acao_endereco" 
                                style="line-height: 1rem;white-space: nowrap;">
                                    <b>Usar endereço da ação</b>
                                </label>
                            </div>
                            <button id="btn-add-pessoa-0"
                            type="button"
                            class="btn btn-primary d-inline-flex ml-2" style="height: 50%" 
                            onclick="addPessoa()">
                            Adicionar Membro
                            </button>
                        </div>
                    </div>
                    <hr>
                    {% if acao %}
                    modo edicao
                    <div id="pessoas_tickets" class="w-100">
                    </div>
                    {% else %}
                    <div id="pessoas_tickets" class="w-100">
                    </div>
                    {% endif %}
                </div>
                <div id="itinerarios" class="tab-pane">
                    <div class="acao-modal-itinerario-container">
                        {% include "itinerarios/itinerario_input.html" %}
                    </div>
                </div>
                {% endif %}
            </div>
        </form>
    </div>
    <div class="custom-modal-footer">      
        <button id="formAcoesPrev" style="display: none;" type="button" class="btn btn-secondary prev mx-2">
            <span id="prevAcoesLink" class=""></span>
            <span>Anterior</span>
        </button>
        <button id="formAcoesNext" type="button" class="btn btn-primary mx-2">
            <span id="nextAcoesLink" class="AcoesMenuLink2">
            </span>
            <span>Próximo</span>
        </button>
        <button 
        {% if acao %}
            onclick="editarAcoes({{acao.id}})" 
        {% else %}
            onclick="cadastrarAcao()" 
        {% endif %}
        id="finishCadastroAcoes" 
        type="button" 
        class="btn btn-primary mx-2">
        {% if acao %}
        <span>Salvar Alterações</span>
        {% else %}
        <span>Cadastrar</span>
        {% endif %}
        </button>
    </div>
</div>
<script>
    var formId = "cadastrarAcaoForm"
    var acaoModelId = "acaoModelId"
    var tabsId = "acaoTabs"
    var cadastrarAcaoModalId = "cadastrarAcaoModal"
    var pessoasTicketsForm = "pessoaAcaoForm"
    var dismissCadastrarAcoesId = "dismissCadastrarAcoes"

    function setMembroExecucaoAddressForm(addressValues, formId = null) {
        let addressFormId = formId ? formId : "collapse_endereco_input_"
        $("*[id^='"+addressFormId+"'").each(function(index) {
            let form = $(this)
            for (key in addressValues) {
                if ($(this).attr("id").includes(key)) {
                    $(this).val(addressValues[key])
                }
            }
        })
    }

    function addPessoa() {
        var forms = $("#pessoas_tickets").children().length
        addMembroExecucaoForm(forms)
        
        if (forms >= 1) {
            $("button[id^=btn-remove-pessoa-").each(function(index) {
                $(this).show()
            })
        }
    }

    function setHideDelete() {
        var forms = $("div[id^='pessoas_ticket_form_container']").length
        if (forms <= 1) {
            $("span[id^=btn-remove-pessoa-]").each(function(index) {
                $(this).hide()
            })
        } else {
            $("span[id^=btn-remove-pessoa-]").each(function(index) {
                $(this).show()
            })
        }
    }

    function removePessoa(id) {
        var forms = $("#pessoas_tickets").children().length

        $("#pessoas_ticket_form_container_" + id).remove()
        setHideDelete()
    }

    function addMembroExecucaoForm(id) {
        $.ajax({
            url: "/membroExecucaoForm",
            type: "GET",
            data: {id: id, hide_remove_button: id == 0},
            success: function (data) {
                $("#pessoas_tickets").append(data);
                let formId = "collapse_endereco_input_" + id
                if ($("#use_acao_endereco").is(":checked")) {
                    setMembroExecucaoAddressForm(getFormData(), formId)
                } 

                setHideDelete()
            }
        });
    }

    function clearModalForm(changedResource = null) {
        if (changedResource) acaoModificadaEventProxy.modificado = changedResource
        if (changedResource) $("#"+dismissCadastrarAcoesId).click()
        $(".custom-modal-fade").trigger("click")
    }

    function cadastrarAcao() {
        $.ajax({
            url: "/saveAcao",
            data: JSON.stringify({"data": getFormData()}),
            headers: { "X-CSRFToken":  '{{ csrf_token }}' },
            dataType: "json",
            contentType: 'application/json',
            method: "POST",
            success: function (data) {
                clearModalForm(data)
            }
        });
    }
    
    function editarAcoes(id) {
        $.ajax({
            url: "/editarAcao/"+id,
            data: JSON.stringify({"data":getFormData()}),
            headers: { "X-CSRFToken":  '{{ csrf_token }}' },
            dataType: "json",
            contentType: 'application/json',
            method: "POST",
            success: function (data) {
                clearModalForm(data)
            }
        });
    }

    function getFormData() {
        let form = $('#'+formId)
        var unindexed_array = form.serializeArray();
        var values = {};
        var pessoa_tickets = []
        $.map(unindexed_array, function (n, i) {
            values[n['name']] = n['value'];
        });

        $("form[id^='pessoaTicketForm-']").each(function(index) {
            var pessoa_ticket = {}
            var pessoa_ticket_unindexed_array = $(this).serializeArray();
            $.map(pessoa_ticket_unindexed_array, function (n, i) {
                pessoa_ticket[n['name']] = n['value'];
            });
            pessoa_tickets.push(pessoa_ticket)
        });
        values["membros_execucao"] = pessoa_tickets

        return values
    }

    function closeBehavior() {
        $('.custom-modal-fade').click(function () {
            $('.custom-modal-fade').fadeToggle();
            $('.custom-modal').fadeToggle();
            $("body").css("overflow", "auto")
        })

        $('.custom-close-modal').click(function () {
            $('.custom-modal-fade').fadeToggle();
            $('.custom-modal').fadeToggle();
            $("body").css("overflow", "auto")
        })

        $('.custom-complete-modal').click(function () {
            $('.custom-modal-fade').fadeToggle();
            $('.custom-modal').fadeToggle();
            $("body").css("overflow", "auto")
        })
    }

    function openCustomModal() {
        $('.custom-modal-fade').fadeIn(250);
        $('.custom-modal').fadeIn(250);
        $("body").css("overflow", "hidden")
    }

    function getActiveTab() {
        let activeTab = $("*[id^='" + "acaoTabs" + "']").filter(function (i, el) {
            return $(el).hasClass("active") || $(el).hasClass("active-acao-form-tab")
        })

        id = $(activeTab[0]).attr("id")

        if (id == undefined) return 0

        id = id.charAt(id.length - 1)
        return id
    }
    
    function getTabs() {
        let activeTabs = $("*[id^='" + "acaoTabs" + "']")
        return activeTabs
    }

    function functionGetTabsQuantity() {
        let tabs = $("*[id^='" + "acaoTabs" + "']")
        return $("*[id^='" + "acaoTabs" + "']").length
    }

    function addEquipeMembersToItinerario() {
        getFormData().membros_execucao.forEach(function (membroEquipe, index) {
            addMembroEquipeOnItinerario(membroEquipe)
        })
    }

    function processItinerarioTab() {
        let activeId = $("#acao-tabs > div:nth-child("+getActiveTab()+")").attr("id")
        let customModalBodyContainer = $(".custom-modal-body-container").first()
        if (activeId == "itinerarios") {
            if (!customModalBodyContainer.hasClass("w-100-vw")) {
                customModalBodyContainer.removeClass("w-75-vw")
                customModalBodyContainer.addClass("w-100-vw")
            }
            addEquipeMembersToItinerario()
            $('body').trigger('reloadMap')
        } else {
            // try {
            //     removeItinerarioEquipeMembers()
            // } catch (e) {
            //     console.log("Erro ao remover membros do itinerario: ", e)
            // }
            customModalBodyContainer.removeClass("w-100-vw")
            customModalBodyContainer.addClass("w-75-vw")
        }
    }

    function showHideTabs(instructions) {
        instructions.show.forEach(function (elementId) {
            $("#" + elementId).show()
        })

        instructions.hide.forEach(function (elementId) {
            $("#" + elementId).hide()
        })

        processItinerarioTab()
    }

    function processTabBtnClick(direction) {
        let activeTab = getActiveTab()
        let nextTab = parseInt(activeTab) + direction
        $("#acoesTabLink" + nextTab).trigger("click")
        $("#acaoTabs" + nextTab).addClass("active-acao-form-tab")
        $("#acaoTabs" + activeTab).removeClass("active-acao-form-tab")
        setTabsbehavior()
    }

    function setTabsbehavior() {
        tabsControl = {
            first: {
                show: ["formAcoesNext"],
                hide: ["formAcoesPrev", "finishCadastroAcoes"]
            },
            last: {
                show: ["formAcoesPrev", "finishCadastroAcoes"],
                hide: ["formAcoesNext"]
            },
            middle: {
                show: ["formAcoesPrev", "formAcoesNext"],
                hide: ["finishCadastroAcoes"]
            },
            only: {
                show: ["finishCadastroAcoes"],
                hide: ["formAcoesPrev", "formAcoesNext"]
            }
        }

        activTabFn = getActiveTab()
        tabsQuantity = functionGetTabsQuantity()
        if (activTabFn == 1 && tabsQuantity > 1) {
            showHideTabs(tabsControl.first)
        } else if (tabsQuantity == 1) {
            showHideTabs(tabsControl.only)
        } else if (activTabFn == tabsQuantity) {
            showHideTabs(tabsControl.last)
        } else {
            showHideTabs(tabsControl.middle)
        }
    }

    function bindEnderecosInputs() {
        $("#logradouro").change(function() {
            if ($("#use_acao_endereco").is(":checked")) {
                setMembroExecucaoAddressForm(getFormData())
            }
        })
        $("#bairro").change(function() {
            if ($("#use_acao_endereco").is(":checked")) {
                setMembroExecucaoAddressForm(getFormData())
            }
        })
        $("#cep").change(function() {
            if ($("#use_acao_endereco").is(":checked")) {
                setMembroExecucaoAddressForm(getFormData())
            }
        })
        $("#complemento").change(function() {
            if ($("#use_acao_endereco").is(":checked")) {
                setMembroExecucaoAddressForm(getFormData())
            }
        })
        $("#cidade_id").change(function() {
            if ($("#use_acao_endereco").is(":checked")) {
                setMembroExecucaoAddressForm(getFormData())
            }
        })
    }
    
    $(document).ready(function () {
        closeBehavior();

        setTabsbehavior()
        $("#formAcoesNext").click(function (event) {
            event.preventDefault()
            processTabBtnClick(1)
        })
        $("#formAcoesPrev").click(function (event) {
            event.preventDefault()
            processTabBtnClick(-1)
        })
        $("#use_acao_endereco").change(function () {
            if (this.checked) setMembroExecucaoAddressForm(getFormData())
        })
        $("body").css("overflow", "hidden")
        bindEnderecosInputs()
        addMembroExecucaoForm(0)
        maskValues()
    })
</script>