{% extends "base.html" %}

{% block content %}
<style>
    .br {
        border: 2px solid red;
    }

    .w-10 {
        width: 10%;
    }

    .w-15 {
        width: 15%;
    }

    .w-2 {
        width: 2%;
    }

    .justify-start {
        display: flex;
        justify-content: flex-start;
    }

    .btn-group-custom button {
        background-color: #fff;
        /* Green background */
        border: 1px solid #e3e6f0;
        /* Green border */
        color: #343a40;
        /* White text */
        padding: 10px 24px;
        /* Some padding */
        cursor: pointer;
        /* Pointer/hand icon */
        float: left;
        /* Float the buttons side by side */
    }

    /* Clear floats (clearfix hack) */
    .btn-group-custom {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
    }

    .btn-group-custom button:not(:last-child) {
        border-bottom: none;
        /* Prevent double borders */
    }

    /* Add a background color on hover */
    .btn-group-custom button:hover {
        background-color: #e3e6f0;
    }

    .btn-circle {
        border: none;
        outline: inherit;
        background-color: #fff;
        width: auto;
        height: 100%;
        padding: 13px 18px;
        border-radius: 60px;
        font-size: 15px;
        text-align: center;
        transition: background-color 0.1s;
    }

    .btn-cadastrar {
        border: none;
        outline: inherit;
        color: white;
        background-color: #1cc88a;
        width: auto;
        height: 100%;
        padding: 13px 18px;
        border-radius: 60px;
        font-size: 15px;
        text-align: center;
        transition: background-color 0.1s;
    }

    .btn-cadastrar:hover {
        background-color: #15865d;
        transition: background-color 0.1s;
    }

    .btn-circle:active {
        background-color: #ececec;
        transition: background-color 0.1s;
    }

    .active-form-tab {
        background-color: #15865d;
        color: white;
    }
</style>
<div id="loadingPessoas" 
style="
background-color: rgba(125,125,125,0.3); 
display: none; 
justify-content: center; 
align-items: center; 
width: 100vw; 
height: 100vh;
position: absolute;
overflow: hidden;
top: 0;
left: 0;
z-index: 4
;">
    <div class="spinner-border" style="z-index: 5;" role="status">
        <span class="sr-only">Carregando...</span>
    </div>
</div>
<div style="width: 100%;" class="">
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-dismissible alert-success" role="alert">
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            <strong class="text-dark">{{message}}</strong>
        </div>
        {% endfor %}
    {% endif %}
    <div class="w-100 shadow
    d-flex justify-content-between align-items-center 
    px-3 py-3 my-3
    bg-white">
        <div class="d-flex justify-content-start align-items-center">
            <input id="filterPessoaNomePessoa" 
            placeholder="Digite um nome" 
            class="mx-2 form-control-sm border-secondary"
            name="nome" type="text">
            <input hidden type="text" value="nome" name="order_by" id="filterPessoa_order_by">
            <input id="filterPessoaDataInicio" 
            type="date"
            class="mx-2 form-control-sm border-secondary"
            name="data_inicio" type="text">
            <input id="filterPessoaDataFim" 
            type="date"
            class="mx-2 form-control-sm border-secondary"
            name="data_fim" type="text">
            <div class="d-flex justify-content-start align-items-center">
                <input id="filterPessoaIsAlocated" 
                type="checkbox"
                class="ml-2 mr-1 form-control-sm"
                id="is_alocated"
                name="is_alocated" 
                type="text">
                <label for="is_alocated" class="m-0">
                    Buscar Alocados 
                </label>
            </div>
        </div>
        <div class="d-flex">
            <button id="alocarPessoasBtn" 
            onclick="alocarPessoas()"
            class="btn-cadastrar rounded d-none justify-content-between align-items-center  ml-1">
                <span> alocar pessoas</span>
            </button>
            <button id="horasTrabalhadasBtn" 
            onclick="horasTrabalhadas()"
            class="btn-cadastrar rounded justify-content-between align-items-center  ml-1">
                <span> Horas Trabalhadas </span>
            </button>
            <button id="adicionarPessoas" 
            onclick="carregarPessoasModalCadastrar()"
            class="btn-cadastrar rounded d-flex justify-content-between align-items-center ml-1">
                <span> cadastrar pessoa</span>
            </button>
        </div>
    </div>
    <div id="receberTabela" class="shadow bg-white w-100">
    </div>
</div>
<a id="download-broshura" name="download-file" download> </a>

<!-- Modal -->
<div id="modalCadastrarContainer">
</div>

<div id="modalAlocarPessoas">
</div>

<div id="calendario" class="d-flex flex-column">
</div>

<script>
    let pessoaModificadaEvent = {};
    let pessoaModificadaEventProxy = null
    let alocarPessoasBtnId = "alocarPessoasBtn"
    let modalAlocarPessoasId = "modalAlocarPessoas"
    let alocarUrl = "pessoasModalAlocar"
    let pessoaTableCheckboxRowId = "pessoaTableCheckboxRow-" 
    let rowPessoaId = "rowPessoa-" 
    let pessoaTableCheckboxAllId = "pessoaTableCheckboxAll"
    let filterPrefix = "filterPessoa"
    let calendarioId = "calendario"
    let calendarioUrl = "calendario"

    function getCheckedIds() {
        let checkedValues = []
        $("input[id^='"+pessoaTableCheckboxRowId+"']").filter(function () {
            if ($(this).is(":checked")) {
                checkedValues.push($(this).attr("id").split("-")[1])
            }
        })
        return checkedValues
    }

    function getFiltros() {
        let filtros = {}
        $("input[id^='"+filterPrefix+"']").each(function() {
            if ($(this).val()) {
                filtros[$(this).attr("name")] = $(this).val()
            }
        })
        filtros["is_alocated"] = $("#"+filterPrefix+"IsAlocated").is(":checked")
        console.log(filtros)
        return filtros
    }

    function alocarPessoas () {
        let checkedValues = getCheckedIds()
        $.ajax({
            url: alocarUrl,
            data: {checked_values: checkedValues},
            type: "GET",
            success: function (data) {
                $("#"+modalAlocarPessoasId).html(data)
                $('#'+alocarPessoaModalId).modal('toggle');
                $("#"+pessoaTableCheckboxAllId).prop('checked', false);
                $("#"+pessoaTableCheckboxAllId).trigger("change");
            }
        });

    }
    
    function getCalendario () {
        $.ajax({
            url: calendarioUrl,
            data: getFiltros(),
            type: "GET",
            success: function (data) {
                $("#"+calendarioId).html(data)
                $('#'+modalCalendarioId).modal('toggle');
            }
        });
    }

    function deletePessoa(id) {
        deletar_url = "eliminarPessoa/" + id

        $.ajax({
            url: deletar_url,
            data: {},
            success: function (data) {
                let menuId = "#hiddenMenuPessoas" + id
                $(menuId).toggle()
                carregarPessoas()
            }
        });
    }
    
    function horasTrabalhadas() {
        getCalendario()
    }

    function carregarPessoas(filter = null) {
        let recarregarTabela = "pessoasTable"
        console.log(filter) 
        $.ajax({
            url: recarregarTabela,
            data: filter,
            success: function (data) {
                $("#receberTabela").html(data);
            }
        });
    }

    function carregarPessoasModalCadastrar(id = null) {
        let recarregarTabela = "pessoasModalCadastrar"
        $.ajax({
            url: recarregarTabela,
            data: id ? {id: id} : {},
            success: function (data) {
                $("#modalCadastrarContainer").html(data);
                $('#cadastrarPessoaModal').modal('toggle');
            }
        });
    }
        
    function visualizarPessoa(id) {
        location.href = "visualizarPessoa/" + id
    }

    function filtrarPessoas() {
        carregarPessoas(getFiltros())
    }

    function debounce(func, timeout = 300){
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => { func.apply(this, args); }, timeout);
        };
    }

    function getCheckboxValue(id) {
        return $("#"+id).is(":checked")
    }

    $(document).ready(function () {
        pessoaModificadaEventProxy = new Proxy(pessoaModificadaEvent, {
            set: function (target, key, value) {
                target[key] = value;
                if (value) {
                    carregarPessoas()
                }
                target[key] = false
                return false;
            }
        });

        nextBtnControl = ["pessoaMenuLink1", "pessoaMenuLink2", "pessoaMenuLink3", "pessoaMenuLink4"]
        tabsQuantity = 4
        item = 1
        $(".nav-tabs a").click(function () {
            $(this).tab('show');
        });

        $("#formPessoaNext").click(function () {
            // buscar os botoes de proximo e anterior
            prevLinkElement = $("#formPessoaPrev").children('#prevPessoaLink')
            nextLinkElement = $(this).children('#nextPessoaLink')

            // buscar nome do proximo link
            nextPessoaLink = nextLinkElement.attr('class')
            $("#" + nextPessoaLink).trigger("click")
            nextLinkElement.removeClass(nextPessoaLink)
            currentLinkNumber = parseInt(nextPessoaLink.slice(-1))
            proximoLink = currentLinkNumber % 4 + 1
            proximoLink = nextPessoaLink.slice(0, -1) + proximoLink
            nextLinkElement.addClass(proximoLink)

            // mudar a cor da aba
            if (currentLinkNumber <= 0) currentLinkNumber = 1
            $("li[id^='pessoasList']").each(function (i, el) {
                currentId = "pessoasList" + currentLinkNumber
                if ($(this).attr('id') == currentId) $(this).addClass("active-form-tab")
                else $(this).removeClass("active-form-tab")
            })

            // salvar o link anterior
            classes = prevLinkElement.attr('class')
            if (classes) {
                prevLinkElement.removeClass(classes)
                currentClassNumber = parseInt(nextPessoaLink.slice(-1))
                prevLink = currentClassNumber % 4 == 0 ? 3 : currentClassNumber % 4 - 1
                prevLink = nextPessoaLink.slice(0, -1) + prevLink
                prevLinkElement.addClass(prevLink)
            } else {
                currentClassNumber = parseInt(nextPessoaLink.slice(-1))
                prevLink = currentClassNumber % 4 - 1
                prevLink = nextPessoaLink.slice(0, -1) + prevLink
                prevLinkElement.addClass(prevLink)
            }

            // mostrar o botao de cadastrar
            if (proximoLink == "pessoaMenuLink1") {
                $("#formPessoaNext").hide()
                $("#finishCadastroPessoa").show()
            }

            // mostrar o botao de anterior
            if (
                proximoLink == "pessoaMenuLink3" ||
                proximoLink == "pessoaMenuLink1" ||
                proximoLink == "pessoaMenuLink4"
            ) {
                $("#formPessoaPrev").show()
            } else $("#formPessoaPrev").hide()
        });

        $("#formPessoaPrev").click(function () {
            // buscar os botoes de proximo e anterior
            prevLinkElement = $("#formPessoaPrev").children('#prevPessoaLink')
            nextLinkElement = $("#formPessoaNext").children('#nextPessoaLink')

            // buscar nome do link anterior
            prevPessoaLink = prevLinkElement.attr('class')
            $("#" + prevPessoaLink).trigger("click")
            currentLinkNumber = parseInt(prevPessoaLink.slice(-1))
            prevLinkElement.removeClass(prevPessoaLink)
            prevLinkAtualizado = currentLinkNumber % 4 - 1
            prevLinkAtualizado = prevPessoaLink.slice(0, -1) + prevLinkAtualizado
            prevLinkElement.addClass(prevLinkAtualizado)

            // mudar a cor da aba
            if (currentLinkNumber <= 0) currentLinkNumber = 1
            if (currentLinkNumber > 4) currentLinkNumber = 4
            $("li[id^='pessoasList']").each(function (i, el) {
                currentId = "pessoasList" + currentLinkNumber
                if ($(this).attr('id') == currentId) $(this).addClass("active-form-tab")
                else $(this).removeClass("active-form-tab")
            })

            // salvar o proximo link
            classes = nextLinkElement.attr('class')
            if (classes == "pessoaMenuLink1") {
                nextLinkElement.removeClass(classes)
                nextink = classes.slice(0, -1) + 4
                nextLinkElement.addClass(nextink)
            } else {
                nextLinkElement.removeClass(classes)
                currentClassNumber = parseInt(classes.slice(-1))
                nextink = currentClassNumber - 1
                nextink = classes.slice(0, -1) + nextink
                nextLinkElement.addClass(nextink)
            }

            // mostrar o botao de cadastrar
            if (prevLinkAtualizado != "pessoaMenuLink3") {
                $("#formPessoaNext").show()
                $("#finishCadastroPessoa").hide()
            }
            // esconder o botao de anterior
            if (
                prevLinkAtualizado == "pessoaMenuLink0"
            ) {
                $("#formPessoaPrev").hide()
            } else $("#formPessoaPrev").show()
        });
        
        $(document).mouseup(function (e) {
            $("div[id^='hiddenMenuPessoas']").each(function (i, el) {
                if (!$(this).is(e.target) && $(this).has(e.target).length === 0) {
                    if ($(this).css('display') != 'none') {
                        $(this).toggle()
                    }
                }
            })
        });
        
        $("input[id^='"+filterPrefix+"']").each(function () {
            let input = $(this)
            if ($(this).attr("id").includes("NomePessoa")) {
                $(this)
                .keyup(debounce(function() {
                    filtrarPessoas()
                }, 500))
            } else {
                $(this)
                .change(debounce(function() {
                    filtrarPessoas()
                }, 500))
            }
        })

        carregarPessoas()
    });

</script>

{% endblock content %}