{% extends "base.html" %}

{% block content %}
<style>
    .cs-tab-link{
        color: gray;
        padding: 8px;
    }
    
    .cs-tab-link .active {
        background-color: #0c504b;
        border-radius: 5px 5px 0px 0px;
        padding: 8px 12px;
        color: white;
    }
    
    .cs-tab-link a{
        text-decoration: none;
        color: gray;
    }

    .cs-tab-link a:hover{
        text-decoration: none;
    }
</style>
<div class="card shadow mb-4 w-100">
    <input type="text" name="order_by" id="filterAlocacaoOrderBy" hidden>
    <div class="d-flex justify-content-between pt-3 px-2">
        <div class="d-flex flex-column">
            <div class="d-flex align-items-center ">
                <i class="fa-solid fa-location-dot "></i>
                <span class="ml-2"><strong>{{ensino.escola.nome}},  </strong>{{ensino.endereco_completo}}</span>
            </div>
            <div class="d-flex align-items-center ">
                <i class="fa-solid fa-calendar-days"></i>
                 <span class="ml-2">de {{ensino.data_inicio|date:"d-m-Y"}}  até </span>
                <span class="ml-2">{{ensino.data_fim|date:"d-m-Y"}}</span>
            </div>
        </div>
        <div class="d-flex align-items-center ">
            <span class="{{ensino.status_class}}">{{ensino.status}}</span>
        </div>
    </div>
    <div class="card-body w-100">
        <ul class="nav nav-tabs w-100">
            <li class=" cs-tab-link active">
                <a id="linkDadosGerais" data-toggle="tab" href="#alocacoes">Alocações</a>
            </li>
        </ul>
        <div class="tab-content w-100">
            <div id="alocacoes" class="tab-pane active in">
                <div id="receberTabelaAlocacoes"></div>
            </div>
        </div>
    </div>
</div>
<div id="modalAlocacaoContainer"></div>
<script>
    let modalCadastrarAlocacaoContainerId = "modalCadastrarAlocacaoContainer"
    let buttonMenuAlocacoesId = "buttonMenuAlocacoes"
    let hiddenMenuAlocacoesId = "hiddenMenuAlocacoes"
    let cadastrarAlocacaoModalId = "cadastrarAlocacaoModal"
    let cadastrarAlocacaoFormId = "cadastrarAlocacaoForm"
    let dismissCadastrarAlocacaoId = "dismissCadastrarAlocacao"
    let rotaDeletarAlocacao = "eliminarAlocacao"
    let rotaModalAlocacao = "alocacaoModalCadastrar"
    let rotaVisualizarAlocacao = "visualizarAlocacao"
</script>
<script>
    let alocacaoModificadaEvent = {};
    let alocacaoModificadaEventProxy = null
    let idTabelaAlocacoes = "receberTabelaAlocacoes"
    let rotaTabelaAlocacoes = "alocacoesTable"
    let acaoEnsinoId = "{{ensino.id}}" 

    function deleteAlocacao(id) {
        deletar_url = "/eliminarAlocacao/" + id

        $.ajax({
            url: deletar_url,
            method: "DELETE",
            data: {},
            headers: { "X-CSRFToken":  '{{ csrf_token }}' },
            success: function (data) {
                let menuId = "#hiddenMenuAlocacoes"+ id
                $(menuId).toggle()
                carregarAlocacoes()
            }
        });
    }

    function carregarAlocacoes(filters = null, state = null) {
        console.log("filtros no frontend: ",filters)
        $.ajax({
            url: "/"+rotaTabelaAlocacoes,
            contentType: 'application/json',
            data: {acaoEnsino_id: acaoEnsinoId, ...filters},
            success: function (data) {
                $("#" + idTabelaAlocacoes).html(data);
                setTabelaState(state, 'column-alocacao', 'pessoa__nome')
            }
        });
    }

    function clearModalFormTicket() {
        $("#cadastrarTicketModal").modal('hide');
        $("#modalTicketContainer").html("");
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();
        carregarAlocacoes()
    }
    
    $(document).ready(function() {
        alocacaoModificadaEventProxy = new Proxy(alocacaoModificadaEvent, {
            set: function (target, key, value) {
                target[key] = value;
                if (value) {
                    carregarAlocacoes()
                    $('#cadastrarAlocacaoModal').modal('hide');
                    $('body').removeClass('modal-open');
                    $('.modal-backdrop').remove();
                }
                target[key] = false
                return false;
            }
        });

        $("#linkDadosGerais").trigger("click")
        carregarAlocacoes()
    })
</script>

{% endblock content %}