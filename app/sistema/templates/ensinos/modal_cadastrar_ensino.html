<style>
    .btn-xsm {
        padding: 0.1rem 0.1rem;
        font-size: 1.0rem;
        line-height: 1.0;
        border-radius: 0.2rem;
    }

    .ellipsis {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .delete-anexo-oficio-btn {
        display: none;
        font-size: 1.2rem;
        height: 50%;
        overflow: auto;
        margin: auto;
        position: absolute;
        overflow: hidden;
        top: 0; 
        bottom: 0; 
        right: 0;
        z-index: 2;
        color: red;
    }
    
    .btn-delete-oficio-background {
        background-color: white;
        width: 15%;
        height: 100%;
        position: absolute;
        top:0;
        right: 0;
        z-index: 1;
        display: none;
    }

    .badge-oficio:hover .delete-anexo-oficio-btn,
    .badge-oficio:hover .btn-delete-oficio-background {
        display: block;
    }
</style>
<div class="modal fade" id="cadastrarEnsinoModal" tabindex="-1" role="dialog"
    aria-labelledby="cadastrarEnsinoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cadastrarEnsinoModalLabel">
                    {% if ensino is None %}
                        Cadastrar Ação de Ensino
                        <span id="ensinoModelId" hidden></span>
                    {% else %}
                        Editar Cadastro de: {{ensino.nome}}
                        <span id="ensinoModelId" hidden>{{ensino.id}}</span>
                    {% endif %}
                </h5>
                <button type="button" 
                id="dismissCadastrarEnsino" 
                class="close" 
                data-bs-dismiss="modal" 
                aria-label="Close">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="w-100">
                    <ul class="nav nav-tabs row">
                        <li id="ensinoList1" class="col py-2 active-form-tab">
                            <a id="ensinoMenuLink1" 
                            style="display: none;" 
                            href="#home">1</a>
                            <span>Dados Gerais</span>
                        </li>
                    </ul>
                    <form id="cadastrarEnsinoForm" action="/" method="POST">
                        <div class="tab-content">
                            <div id="home" class="tab-pane py-3 active">
                                <div class="form-group row">
                                    <div class="col-sm-12">
                                        <label><b>Descrição:</b></label>
                                        <textarea
                                        class="form-control"
                                        id="observacao"
                                        name="observacao"
                                        rows="3"
                                        >{% if ensino %}{{ensino.observacao}}{% endif %}</textarea>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-sm-2">
                                        <label>
                                            <span><b>Nº Ofício:</b></span>
                                        </label>
                                        <input 
                                        type="text" 
                                        {% if ensino %}
                                        value="{{ensino.numero_oficio}}" 
                                        {% endif %}
                                        class="form-control" 
                                        id="numero_oficio" 
                                        name="numero_oficio" 
                                        placeholder=""
                                        required>
                                    </div>
                                    <div class="col-sm-3 d-flex flex-column justify-content-start align-items-start">
                                        <label>
                                            <span><b>Anexo Ofício:</b></span>
                                        </label>
                                        <div id="oficio-anexo-container" 
                                        class="d-flex justify-content-between align-items-center w-100">
                                            <button id="add-anexo-oficio" type="button"
                                            style="height: calc(1.5em + .75rem + 2px);"
                                            data-toggle="tooltip" 
                                            data-placement="top" 
                                            title="Anexar Ofício"
                                            class="btn btn-light w-15">
                                                <i class="fa-solid fa-paperclip"></i>
                                            </button>
                                            {% if ensino.anexo_oficio %}
                                            <div id="document-badge"
                                            style="height: calc(1.5em + .75rem + 2px); cursor: pointer;position: relative" 
                                            data-toggle="tooltip"
                                            data-placement="top"
                                            title="${oficioName}"
                                            class="ellipsis badge badge-primary d-flex align-items-center w-80 badge-oficio">
                                                <span>{{ensino.anexo_oficio.nome}}</span>
                                                <i class="fas fa-trash mx-1 delete-anexo-oficio-btn" 
                                                data-toggle="tooltip"
                                                data-placement="top"
                                                title="Remover oficio"
                                                onclick="removeAnexoOficio(this)"></i>
                                                <div class="btn-delete-oficio-background"></div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-sm-3">
                                        <label><b>Etapa:</b></label>
                                        <select class="form-control" 
                                        id="etapa" name="etapa">
                                            <option 
                                            {% if ensino %}
                                                {% if ensino.etapa == None or ensino.etapa == '' %}
                                                    selected
                                                {% endif %}
                                            {% else %}
                                                selected 
                                            {% endif %}
                                            value="">selecione uma etapa</option>
                                            <option 
                                            {% if ensino %}
                                                {% if ensino.etapa == '1' %}
                                                    selected
                                                {% endif %}
                                            {% endif %}
                                            value="1">1</option>
                                            <option 
                                            {% if ensino %}
                                                {% if ensino.etapa == '2' %}
                                                    selected
                                                {% endif %}
                                            {% endif %}
                                            value="2">2</option>
                                            <option 
                                            {% if ensino %}
                                                {% if ensino.etapa == '3' %}
                                                    selected
                                                {% endif %}
                                            {% endif %}
                                            value="3">3</option>
                                            <option 
                                            {% if ensino %}
                                                {% if ensino.etapa == '4' %}
                                                    selected
                                                {% endif %}
                                            {% endif %}
                                            value="4">4</option>
                                            <option 
                                            {% if ensino %}
                                                {% if ensino.etapa == '5' %}
                                                    selected
                                                {% endif %}
                                            {% endif %}
                                            value="5">5</option>
                                            <option 
                                            {% if ensino %}
                                                {% if ensino.etapa == '6' %}
                                                    selected
                                                {% endif %}
                                            {% endif %}
                                            value="6">6</option>
                                            <option 
                                            {% if ensino %}
                                                {% if ensino.etapa == '7' %}
                                                    selected
                                                {% endif %}
                                            {% endif %}
                                            value="7">7</option>
                                            <option 
                                            {% if ensino %}
                                                {% if ensino.etapa == '8' %}
                                                    selected
                                                {% endif %}
                                            {% endif %}
                                            value="8">8</option>
                                            <option 
                                            {% if ensino %}
                                                {% if ensino.etapa == '9' %}
                                                    selected
                                                {% endif %}
                                            {% endif %}
                                            value="9">9</option>
                                            <option 
                                            {% if ensino %}
                                                {% if ensino.etapa == '10' %}
                                                    selected
                                                {% endif %}
                                            {% endif %}
                                            value="10">10</option>
                                        </select>
                                    </div>
                                    <div id="ensinoFormSelectEscola" class="col-sm-4">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-sm-3">
                                        <label><b>Status:</b></label>
                                        <select required class="form-control" 
                                        id="status" name="status">
                                            <option 
                                            {% if ensino %}
                                                {% if ensino.status == 'planejamento' %}
                                                    selected
                                                {% endif %}
                                            {% endif %}
                                            value="planejamento">Planejamento</option>
                                            <option 
                                            {% if ensino %}
                                                {% if ensino.status == 'andamento' %}
                                                    selected
                                                {% endif %}
                                            {% endif %}
                                            value="andamento">Em Andamento</option>
                                            <option 
                                            {% if ensino %}
                                                {% if ensino.status == 'finalizado' %}
                                                    selected
                                                {% endif %}
                                            {% endif %}
                                            value="finalizado">Finalizado</option>
                                            <option 
                                            {% if ensino %}
                                                {% if ensino.status == 'adiado' %}
                                                    selected
                                                {% endif %}
                                            {% endif %}
                                            value="adiado">Adiado</option>
                                            <option 
                                            {% if ensino %}
                                                {% if ensino.status == 'cancelado' %}
                                                    selected
                                                {% endif %}
                                            {% endif %}
                                            value="cancelado">Cancelado</option>
                                        </select>
                                    </div>
                                    <div class="col-sm-3">
                                        <label><b>Data de Inicio:</b></label>
                                        <input 
                                        type="datetime-local"
                                        {% if ensino %}
                                        value="{{ ensino.data_inicio}}" 
                                        {% endif %}
                                        class="form-control" 
                                        id="data_inicio"
                                        name="data_inicio"
                                        placeholder=""
                                        required>
                                    </div>
                                    <div class="col-sm-3">
                                        <label><b>Data de Fim:</b></label>
                                        <input 
                                        type="datetime-local"
                                        {% if ensino %}
                                        value="{{ ensino.data_fim}}" 
                                        {% endif %}
                                        class="form-control" 
                                        id="data_fim"
                                        name="data_fim"
                                        placeholder=""
                                        required>
                                    </div>
                                    <div class="col-sm-3">
                                        <div class="d-flex justify-content-space-between align-items-center">
                                            <label><b>Tipo:</b></label>
                                            <div class="d-flex justify-content-space-between align-items-center">
                                                <label class="mr-1" for="has_credito_social">Possui crédito social</label>
                                                <input class="mb-1" 
                                                {% if ensino.has_credito_social == True %}
                                                checked
                                                {% endif %}
                                                type="checkbox" 
                                                id="has_credito_social" 
                                                name="has_credito_social">
                                            </div>
                                        </div>
                                        <select class="form-control"
                                        name="tipo">
                                            <option  
                                            value="">Selecione um tipo</option>
                                            <option {% if ensino.tipo == 'gps' %} selected {% endif %}  
                                            value="gps">GPS</option>
                                            <option {% if ensino.tipo == 'emprestimo' %} selected {% endif %}  
                                            value="emprestimo">Empréstimo</option>
                                            <option {% if ensino.tipo == 'outros' %} selected {% endif %}  
                                            value="outros">Outros</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="dadosNovoEndereco form-group row">
                                    <div id="ensinoFormSelectCidade" class="col-sm-4">
                                    </div>
                                    <div class="col-sm-4">
                                        <label><b>Bairro:</b></label>
                                        <input 
                                        type="text" 
                                        class="form-control" 
                                        {% if ensino %}
                                            {% if ensino.bairro %}
                                            value="{{ensino.bairro}}" 
                                            {% else %}
                                            value="{{ensino.endereco.bairro}}" 
                                            {% endif %}
                                        {% endif %}
                                        id="bairro" 
                                        name="bairro" 
                                        placeholder=""
                                        required>
                                    </div>
                                    <div class="col-sm-4">
                                        <label><b>CEP: </b></label>
                                        <input 
                                        type="text" 
                                        class="form-control" 
                                        {% if ensino %}
                                            {% if ensino.cep %}
                                            value="{{ensino.cep}}" 
                                            {% else %}
                                            value="{{ensino.endereco.cep}}" 
                                            {% endif %}
                                        {% endif %}
                                        id="cep" 
                                        name="cep" 
                                        placeholder=""
                                        required>
                                    </div>
                                </div>
                                <div class="dadosNovoEndereco form-group row">
                                    <div class="col-sm-4">
                                        <label><b>Logradouro:</b></label>
                                        <input 
                                        type="text" 
                                        class="form-control" 
                                        {% if ensino %}
                                            {% if ensino.logradouro %}
                                            value="{{ensino.logradouro}}" 
                                            {% else %}
                                            value="{{ensino.endereco.logradouro}}" 
                                            {% endif %}
                                        {% endif %}
                                        id="logradouro" 
                                        name="logradouro" 
                                        placeholder=""
                                        required>
                                    </div>
                                    <div class="col-sm-8">
                                        <label><b>Complemento:</b></label>
                                        <input 
                                        type="text" 
                                        class="form-control" 
                                        {% if ensino %}
                                            {% if ensino.complemento %}
                                            value="{{ensino.complemento}}" 
                                            {% else %}
                                            value="{{ensino.endereco.complemento}}" 
                                            {% endif %}
                                        {% endif %}
                                        id="complemento" 
                                        name="complemento"
                                        placeholder="" 
                                        required>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="file" id="anexoFileInput" style="display: none;" />
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button
                {% if ensino %}
                    onclick="processarEditarEnsino('{{ensino.id}}')" 
                {% else %}
                    onclick="processarCadastrarEnsino()" 
                {% endif %}
                id="finishCadastroEnsino" 
                type="button"
                class="btn btn-primary">
                {% if ensino %}
                    <span>Salvar Alterações</span>
                {% else %}
                    <span>Cadastrar</span>
                {% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

{{ escolas|json_script:"escolas-script" }}

<script>
    formId = "cadastrarEnsinoForm"
    ensinoModelId = "ensinoModelId"
    oficioName = null
    inputReaderDataUrl = null
    ensinoFormSelectCidadeId = "ensinoFormSelectCidade"
    ensinoFormSelectEnderecosId = "ensinoFormSelectEnderecos"
    selectedCidadeId = "{% if ensino.cidade %}{{ensino.cidade.id}}{% else %}{{ensino.endereco.cidade.id}}{% endif %}"
    selectedEscolaId = "{{ensino.escola.id}}"
    selectedEnderecoId = "{{ensino.endereco.id}}"
    isEditing = "{{ensino.id}}"
    var escolas = JSON.parse(document.getElementById('escolas-script').textContent);
    ensinoFormSelectEscolaId = "ensinoFormSelectEscola"

    function clearModalForm(changedResource = null) {
        document.getElementById(formId).reset();

        if (changedResource) carregarEnsinos()
        if (changedResource) $("#"+dismissCadastrarEnsinoId).click()
    }

    function cadastrarEnsino(data) {
        // if (!data["numero_oficio"]) {
        //     showFloatingMessage("Não é possivel cadastrar uma ação de ensino sem o número do ofício", "alert-danger");
        //     return
        // }
        toggleLoading("update demanda")
        console.log(data)
        $.ajax({
            url: "saveEnsino",
            data: JSON.stringify({"data":data}),
            dataType: "json",
            headers: { "X-CSRFToken":  '{{ csrf_token }}' },
            contentType: 'application/json',
            method: "POST",
            success: function (data) {
                toggleLoading("update demanda")
                showFloatingMessage("Ação de ensino cadastrada com sucesso", "alert-success");
                clearModalForm(data)
            },
            error: function (data) {
                showFloatingMessage("Erro ao cadastrar Ação de ensino", "alert-danger");
                toggleLoading("update demanda")
            }
        });
    }

    function processarCadastrarEnsino() {
        let formData = getFormData()
        cadastrarEnsino(formData)
    }

    function editarEnsino(ensinoId, formData) {
        // if (!formData["numero_oficio"]) {
        //     showFloatingMessage("Não é possivel cadastrar uma ação de ensino sem o número do ofício", "alert-danger");
        //     return
        // }
        $.ajax({
            url: "editarEnsino/"+ensinoId,
            data: JSON.stringify({"data":formData}),
            headers: { "X-CSRFToken":  '{{ csrf_token }}' },
            dataType: "json",
            contentType: 'application/json',
            method: "PUT",
            success: function (data) {
                clearModalForm(data)
            }
        });
    }

    function getFormData() {
        let form = $('#'+formId)
        var unindexed_array = form.serializeArray();
        enderecoFields = ["logradouro", "bairro", "cep", "complemento", "cidade_id"]
        var values = {};
        var endereco = {}
        $.map(unindexed_array, function (n, i) {
            if (enderecoFields.includes(n['name'])) {
                endereco[n['name']] = n['value']
            }
            values[n['name']] = n['value'];
        });
        values["endereco"] = endereco
        values["oficio_data_url"] = inputReaderDataUrl
        values["oficio_name"] = oficioName
        values["has_credito_social"] =  $("#has_credito_social").is(":checked")
        return values
    }

    function updateSelectedCidade() {
        if (selectedCidadeId) {
            let cidade = $("#cidade_id").val(selectedCidadeId);
        }
    }
    
    function updateSelectedEscola() {
        if (selectedEscolaId.length > 0) {
            let escola = $("#escola_id").val(selectedEscolaId);
        } else {
            let escola = $("#escola_id").val("");
        }
    }

    function updateSelectedEndereco() {
        if (selectedEnderecoId) {
            $("#endereco_id").val(selectedEnderecoId).change();
        }
    }

    function mostrarEndereco() {

    }

    function carregarSelectCidades() {
        $.ajax({
            url: "cidadesSelect",
            method: "GET",
            success: function (data) {
                $("#"+ensinoFormSelectCidadeId).html(data)
                updateSelectedCidade()
            }
        });
    }

    function getCheckBoxValue(checkboxId) {
        return $("#"+checkboxId).is(":checked")
    }

    function bindEnderecoFields(escolaId) {
        let escola = escolas.find(escola => escola.id == escolaId)
        if (escola && getCheckBoxValue("use_select_value")) {
            $("#logradouro").val(escola.logradouro)
            $("#bairro").val(escola.bairro)
            $("#cep").val(escola.cep)
            $("#complemento").val(escola.complemento)
            $("#cidade_id").val(escola.cidade.id)
        }
    } 
    
    function carregarSelectEscolas() {
        $.ajax({
            url: "escolasSelect",
            method: "GET",
            success: function (data) {
                $("#"+ensinoFormSelectEscolaId).html(data)
                $("#escola_id").change(function (val) {
                    let selectedEscola = $(this).val() 
                    bindEnderecoFields(selectedEscola)
                })

                $("#use_select_value").change(function (val) {
                    let selectedEscola = $("#escola_id").val() 
                    bindEnderecoFields(selectedEscola)
                })
                updateSelectedEscola()
            }
        });
    }
    
    function processarEditarEnsino(ensinoId) {
        let formData = getFormData()
        editarEnsino(ensinoId,formData)
    }

    function removeAnexoOficio(element) {
        $("#document-badge").remove()
        inputReaderDataUrl = null
        oficioName = null
    }

    $(document).ready(function () {
        $("#"+cadastrarEnsinoModalId).on('hide.bs.modal', function(){
            let pessoaId = $("#"+ensinoModelId).text()
            if (pessoaId) {
                clearModalForm()
            }
        });

        $('#add-anexo-oficio').click(function() {
                $('#anexoFileInput').click();
        });

        $('#anexoFileInput').change(function() {
            var file = this.files[0];
            var reader = new FileReader();
            
            reader.onloadend = function() {
                inputReaderDataUrl = reader.result;
                oficioName = file.name;
                $("#document-badge").remove()
                $("#oficio-anexo-container").append(
                    `<div id="document-badge"
                    style="height: calc(1.5em + .75rem + 2px); cursor: pointer;position: relative" 
                    data-toggle="tooltip"
                    data-placement="top"
                    title="${oficioName}"
                    class="ellipsis badge badge-primary d-flex align-items-center w-80 badge-oficio">
                        <span>${oficioName}</span>
                        <i class="fas fa-trash mx-1 delete-anexo-oficio-btn" 
                        data-toggle="tooltip"
                        data-placement="top"
                        title="Remover oficio"
                        onclick="removeAnexoOficio(this)"></i>
                        <div class="btn-delete-oficio-background"></div>
                    </div>`
                )

            }

            reader.readAsDataURL(file);
        });

        carregarSelectCidades()
        carregarSelectEscolas()
        maskValues()
    });
</script>