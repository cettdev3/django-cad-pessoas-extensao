<div class="w-100">
    <form id="cadastrardpEventoForm" action="/" method="POST">
        <div class="form-group row">
            <div class="col-sm-4">
                <label><b>Tipo:</b></label>
                <select required 
                id="tipo"
                onchange="selectTipoDpEvento(this.value)"
                class="form-control" 
                name="tipo">
                    <option
                    value="">
                        Selecione uma opção
                    </option>
                    <option
                    {% if dpEvento and dpEvento.tipo == "emprestimo" %} selected {% endif %}
                    value="emprestimo">
                        EMPRÉSTIMO
                    </option>
                    <option 
                    {% if dpEvento and dpEvento.tipo == "curso_gps" %} selected {% endif %} 
                    value="curso_gps">
                        CURSO GPS
                    </option>
                    <option 
                    {% if dpEvento and dpEvento.tipo == "feirao" %} selected {% endif %} 
                    value="feirao">
                        FEIRÃO DO EMPREGO
                    </option>
                    <option 
                    {% if dpEvento and dpEvento.tipo == "goias_feito_a_mao" %} selected {% endif %} 
                    value="goias_feito_a_mao">
                        GOIÁS FEITO À MÃO
                    </option>
                    <option 
                    {% if dpEvento and dpEvento.tipo == "mutirao" %} selected {% endif %} 
                    value="mutirao">
                        MUTIRÃO
                    </option>
                    <option 
                    {% if dpEvento and dpEvento.tipo == "recicla_goias" %} selected {% endif %} 
                    value="recicla_goias">
                        RECICLA GOIÁS
                    </option>
                    <option 
                    {% if dpEvento and dpEvento.tipo == "outro" %} selected {% endif %}
                    value="outro">
                        OUTRO
                    </option>
                </select>
            </div>
            <div class="col-sm-4">
                {% if dpEvento %}
                {% include 'escolas/escolas_select.html' with escola_id=dpEvento.escola.id escolas=escolas %}
                {% else %}
                {% include 'escolas/escolas_select.html' %}
                {% endif %}
            </div>
            <div id="acao-ensino-select-container" class="col-sm-4">
                {% if dpEvento %}
                {% include 'ensinos/ensino_select.html' with selectes=dpEvento.acaoEnsino.id ensinos=ensinos %}
                {% else %}
                {% include 'ensinos/ensino_select.html' %}
                {% endif %}
            </div>
        </div>
        
        <div class="form-group row">
            <div class="col-sm-12">
                <label><b>Descrição:</b></label>
                <textarea 
                rows="4"
                name="descricao" 
                class="form-control">{% if dpEvento %}{{dpEvento.descricao}}{% endif %}</textarea>
            </div>
        </div>
        <div class="form-group row">
            <div class="col-sm-3">
                <label><b>Data Início:</b></label>
                <input 
                type="date" 
                name="data_inicio" 
                class="form-control" 
                {% if dpEvento %}
                value="{{dpEvento.data_inicio}}"
                {% endif %}>
            </div>
            <div class="col-sm-3">
                <label><b>Data Fim:</b></label>
                <input 
                type="date" 
                name="data_fim" 
                class="form-control" 
                {% if dpEvento %}
                value="{{dpEvento.data_fim}}"
                {% endif %}>
            </div>
            <div id="select_cidade" class="col-sm-3">
            </div>
            <div class="col-sm-3">
                <label><b>CEP:</b></label>
                <input 
                type="text" 
                name="cep" 
                id="cep" 
                class="form-control" 
                {% if dpEvento %}
                value="{{dpEvento.cep}}"
                {% endif %}>
            </div>
        </div>
        <div class="form-group row">
            <div class="col-sm-4">
                <label><b>Bairro:</b></label>
                <input 
                type="text" 
                name="bairro" 
                id="bairro" 
                class="form-control" 
                {% if dpEvento %}
                value="{{dpEvento.bairro}}"
                {% endif %}>
            </div>
            <div class="col-sm-4">
                <label><b>Logradouro:</b></label>
                <input 
                type="text" 
                name="logradouro" 
                id="logradouro" 
                class="form-control" 
                {% if dpEvento %}
                value="{{dpEvento.logradouro}}"
                {% endif %}>
            </div>
            <div class="col-sm-4">
                <label><b>Complemento:</b></label>
                <input 
                type="text" 
                name="complemento" 
                id="complemento" 
                class="form-control" 
                {% if dpEvento %}
                value="{{dpEvento.complemento}}"
                {% endif %}>
            </div>
        </div>
    </form>
</div>
{{ escolas|json_script:"escolas-script" }}
<script>
    var cidade_id = "{% if dpEvento %}{{dpEvento.cidade.id}}{% else %}{% endif %}";
    var escolas = JSON.parse(document.getElementById("escolas-script").textContent);

    function selectTipoDpEvento(value) {
        if (value != "curso_gps") $("#acao-ensino-select-container").hide()
        else $("#acao-ensino-select-container").show()
    }

    function carregarSelectCidades(cidade_id) {
        $.ajax({
            url: "/cidadesSelect",
            method: "GET",
            data: {cidade_id: cidade_id},
            success: function (data) {
                $("#select_cidade").html(data)
                $("#select_cidade").children("select").on("change", function () {
                    console.log("cidade modificada: ",$(this).val())
                    $("collapse_endereco_")
                });
            }
        });
    }
    
    function getCheckBoxValue(id) {
        return $("#"+id).is(':checked')
    }

    function bindEnderecoFields(escolaId) {
        let escola = escolas.find(escola => escola.id == escolaId)
        if (escola && getCheckBoxValue("use_select_value")) {
            $("#logradouro").val(escola.logradouro).trigger("change")
            $("#bairro").val(escola.bairro).trigger("change")
            $("#cep").val(escola.cep).trigger("change")
            $("#complemento").val(escola.complemento).trigger("change")
            $("#cidade_id").val(escola.cidade.id).trigger("change")
        }
    } 

    function carregarSelectEscolas() {
        $.ajax({
            url: "/escolasSelect",
            method: "GET",
            success: function (data) {
                $("#dpEventoFormSelectCidade").html(data)
                $("#escola_id").change(function (val) {
                    let selectedEscola = $(this).val() 
                    bindEnderecoFields(selectedEscola)
                })

                $("#use_select_value").change(function (val) {
                    let selectedEscola = $("#escola_id").val() 
                    bindEnderecoFields(selectedEscola)
                })
            }
        });
    }

    $(document).ready(function () {
        carregarSelectCidades(cidade_id)
        carregarSelectEscolas()
    })
</script>